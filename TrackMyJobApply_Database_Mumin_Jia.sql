DROP TABLE ACCOUNT;
DROP TABLE PAIDACCOUNT;
DROP TABLE FREEACCOUNT;
DROP TABLE APPLY;
DROP TABLE JOB;
DROP TABLE INTERNSHIP;
DROP TABLE FULLTIME;
DROP TABLE PARTTIME;
DROP TABLE ADDRESS;
DROP TABLE COMPANY;
DROP TABLE TECHNOLOGY;
DROP TABLE FINANCIAL;
DROP TABLE HEALTHCARE;

CREATE TABLE ACCOUNT(
AccountID DECIMAL(12) NOT NULL,
AccountUsername VARCHAR(64) NOT NULL,
FirstName VARCHAR(255) NOT NULL,
LastName VARCHAR(255) NOT NULL,
Password VARCHAR(255) NOT NULL,
CreatedOn DATE NOT NULL,
AccountType CHAR(1) NOT NULL,
PRIMARY KEY (AccountID));

CREATE TABLE FREEACCOUNT(
AccountID DECIMAL(12) NOT NULL,
PRIMARY KEY (AccountID),
FOREIGN KEY (AccountID) REFERENCES ACCOUNT);

CREATE TABLE PAIDACCOUNT(
AccountID DECIMAL(12) NOT NULL,
AccountBalance DECIMAL(7,2) NOT NULL,
PaidDate DATE NOT NULL,
PRIMARY KEY (AccountID),
FOREIGN KEY (AccountID) REFERENCES ACCOUNT);

CREATE TABLE COMPANY(
CompanyID DECIMAL(12) NOT NULL,
CompanyName VARCHAR(255) NOT NULL,
HeadquarterAddress VARCHAR(255) NOT NULL,
CompanyType CHAR(1) NOT NULL,
PRIMARY KEY (CompanyID));

CREATE TABLE TECHNOLOGY(
CompanyID DECIMAL(12) NOT NULL,
PRIMARY KEY (CompanyID),
FOREIGN KEY (CompanyID) REFERENCES COMPANY);

CREATE TABLE FINANCIAL(
CompanyID DECIMAL(12) NOT NULL,
PRIMARY KEY (CompanyID),
FOREIGN KEY (CompanyID) REFERENCES COMPANY);

CREATE TABLE HEALTHCARE(
CompanyID DECIMAL(12) NOT NULL,
PRIMARY KEY (CompanyID),
FOREIGN KEY (CompanyID) REFERENCES COMPANY);

CREATE TABLE ADDRESS(
AddressID DECIMAL(12) NOT NULL,
State VARCHAR(255) NOT NULL,
City VARCHAR(255) NOT NULL,
PRIMARY KEY (AddressID));

CREATE TABLE JOB(
JobID DECIMAL(12) NOT NULL,
CompanyID DECIMAL(12) NOT NULL,
AddressID DECIMAL(12) NOT NULL,
JobName VARCHAR(255) NOT NULL,
JobType CHAR(1) NOT NULL,
PRIMARY KEY (JobID),
FOREIGN KEY (CompanyID) REFERENCES COMPANY,
FOREIGN KEY (AddressID) REFERENCES ADDRESS);

CREATE TABLE INTERNSHIP(
JobID DECIMAL(12) NOT NULL,
PRIMARY KEY (JobID),
FOREIGN KEY (JobID) REFERENCES JOB);

CREATE TABLE FULLTIME(
JobID DECIMAL(12) NOT NULL,
PRIMARY KEY (JobID),
FOREIGN KEY (JobID) REFERENCES JOB);

CREATE TABLE PARTTIME(
JobID DECIMAL(12) NOT NULL,
PRIMARY KEY (JobID),
FOREIGN KEY (JobID) REFERENCES JOB);

CREATE TABLE APPLY(
ApplyID DECIMAL(12) NOT NULL,
AccountId DECIMAL(12) NOT NULL,
CompanyID DECIMAL(12) NOT NULL,
JobID DECIMAL(12) NOT NULL,
Status VARCHAR(255) NOT NULL,
ApplyDate DATE NOT NULL,
PRIMARY KEY (ApplyID),
FOREIGN KEY (AccountID) REFERENCES Account,
FOREIGN KEY (CompanyID) REFERENCES Company,
FOREIGN KEY (JobID) REFERENCES Job);

CREATE INDEX PaidAccountBalanceIdx
ON PAIDACCOUNT(AccountBalance);

CREATE INDEX AppApplyDateIdx
ON APPLY(ApplyDate);

CREATE INDEX AccountCreatedOnIdx
ON Account(CreatedOn);

CREATE INDEX AppAccountIDIdx
ON Apply(AccountID);

CREATE INDEX AppCompanyIDIdx
ON Apply(CompanyID);

CREATE INDEX AppJobIDIdx
ON APPLY(JobID);

CREATE INDEX JobCompnyIDIdx
ON Job(CompanyID);

CREATE INDEX JobAddressIDIdx
ON Job(AddressID);


--Add free account procedure
CREATE OR REPLACE PROCEDURE AddFreeACCOUNT(ACCOUNTID IN DECIMAL, ACCOUNTUSERNAME IN VARCHAR, FIRSTNAME IN VARCHAR,
    LASTNAME IN VARCHAR, PASSWORD IN VARCHAR)
AS
BEGIN
    INSERT INTO ACCOUNT(ACCOUNTID, ACCOUNTUSERNAME, FIRSTNAME, LASTNAME, PASSWORD, CREATEDON, ACCOUNTTYPE)
    VALUES(ACCOUNTID, ACCOUNTUSERNAME, FIRSTNAME, LASTNAME, PASSWORD, SYSDATE(), 'F');
    
    INSERT INTO FREEACCOUNT(ACCOUNTID)
    VALUES(ACCOUNTID);
END;

BEGIN
    AddFreeAccount(0100, 'Ndenton', 'Norah', 'Denton', '960100');
    COMMIT;
END;


--AddTechCompany procedure
CREATE OR REPLACE PROCEDURE AddTechCompany(COMPANYID IN DECIMAL, COMPANYNAME IN VARCHAR, HEADQUARTERADDRESS IN
    VARCHAR)
AS
BEGIN 
    INSERT INTO COMPANY(COMPANYID, COMPANYNAME, HEADQUARTERADDRESS, COMPANYTYPE)
    VALUES(COMPANYID, COMPANYNAME, HEADQUARTERADDRESS, 'T');
    
    INSERT INTO TECHNOLOGY(COMPANYID)
    VALUES(COMPANYID);
END;

BEGIN
    AddTechCompany(4042, 'Amazon', 'Seattle');
    COMMIT;
END;

--AddAddress procedure
CREATE OR REPLACE PROCEDURE AddAddress(ADDRESSID IN DECIMAL, STATE IN VARCHAR, CITY IN VARCHAR)
AS
BEGIN 
    INSERT INTO Address(ADDRESSID, STATE, CITY)
    VALUES(ADDRESSID, STATE, CITY);
END;

BEGIN
    AddAddress(02647, 'WA', 'Seattle');
    COMMIT;
END;

--Addjob procedure
CREATE OR REPLACE PROCEDURE AddJob(JOBID IN DECIMAL, COMPANYID IN DECIMAL, ADDRESSID IN DECIMAL, JOBNAME IN VARCHAR)
AS 
BEGIN 
    INSERT INTO JOB(JOBID, COMPANYID, ADDRESSID, JOBNAME, JOBTYPE)
    VALUES(JOBID, COMPANYID, ADDRESSID, JOBNAME, 'I');
END;

BEGIN
    AddJob(23890145, 4042, 02647, 'Software Engineer');
    COMMIT;
END;


--Create StatusChange Table
CREATE TABLE STATUSCHANGE(
STATUSCHANGEID DECIMAL(12) NOT NULL,
OLDSTATUS VARCHAR(255) NOT NULL,
NEWSTATUS VARCHAR(255) NOT NULL,
APPLYID DECIMAL(12) NOT NULL,
CHANGEDATE DATE NOT NULL,
PRIMARY KEY (STATUSCHANGEID),
FOREIGN KEY (APPLYID) REFERENCES APPLY);

--Create Status Change Trigger
CREATE OR REPLACE TRIGGER StatusChangeTrigger
BEFORE UPDATE OF Status ON APPLY
FOR EACH ROW
BEGIN
    INSERT INTO statuschange(STATUSCHANGEID, OLDSTATUS, NEWSTATUS, APPLYID, CHANGEDATE)
    VALUES(NVL((SELECT MAX(StatusChangeID)+1 FROM StatusChange), 1),
            :OLD.STATUS,
            :NEW.STATUS,
            :New.ApplyID,
            trunc(sysdate));
END;

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(12,100, 4042, 23890145, 'In progress', CAST('14-APRIL-2020' AS DATE));

SELECT*
FROM APPLY;

UPDATE APPLY
SET STATUS = 'Interview'
WHERE APPLYID = 12;

UPDATE APPLY
SET STATUS = 'No longer consideration'
WHERE APPLYID = 12;

SELECT *
FROM STATUSCHANGE;

---Insert information into Account table
INSERT INTO ACCOUNT(AccountID, ACCOUNTUSERNAME, FIRSTNAME, LASTNAME, PASSWORD, CREATEDON, ACCOUNTTYPE)
VALUES(101, 'JohnSmith', 'John', 'Smith', '134235', CAST('04-May-2019' AS DATE),'F');

INSERT INTO ACCOUNT(AccountID, ACCOUNTUSERNAME, FIRSTNAME, LASTNAME, PASSWORD, CREATEDON, ACCOUNTTYPE)
VALUES(102, 'MaryBerman', 'Mary', 'Berman', '987345', CAST('09-Feb-2020' AS DATE), 'F');

INSERT INTO ACCOUNT(AccountID, ACCOUNTUSERNAME, FIRSTNAME, LASTNAME, PASSWORD, CREATEDON, ACCOUNTTYPE)
VALUES(103, 'PeterQuigley', 'Peter', 'Quigley', '478360', CAST('21-June-2019' AS DATE), 'F');

INSERT INTO ACCOUNT(AccountID, ACCOUNTUSERNAME, FIRSTNAME, LASTNAME, PASSWORD, CREATEDON, ACCOUNTTYPE)
VALUES(105, 'HilaryMarsh', 'Hilary', 'Marsh', '891478', CAST('16-March-2020' AS DATE), 'P');

INSERT INTO ACCOUNT(AccountID, ACCOUNTUSERNAME, FIRSTNAME, LASTNAME, PASSWORD, CREATEDON, ACCOUNTTYPE)
VALUES(106, 'StantonHurley', 'Stanton', 'Hurley', '352897', CAST('25-April-2020' AS DATE), 'P');

SELECT *
FROM ACCOUNT;

--Insert information into Company table
INSERT INTO COMPANY(COMPANYID, COMPANYNAME, HEADQUARTERADDRESS, COMPANYTYPE)
VALUES(4043, 'Apple', 'Cuptertino', 'T');

INSERT INTO COMPANY(COMPANYID, COMPANYNAME, HEADQUARTERADDRESS, COMPANYTYPE)
VALUES(4044, 'PWC', 'New York', 'F');

INSERT INTO COMPANY(COMPANYID, COMPANYNAME, HEADQUARTERADDRESS, COMPANYTYPE)
VALUES(4045, 'Johnson and Johnson', 'New Brunswick', 'H');

INSERT INTO COMPANY(COMPANYID, COMPANYNAME, HEADQUARTERADDRESS, COMPANYTYPE)
VALUES(4046, 'Uber Technology', 'San Francisco', 'T');

SELECT *
FROM Company;

--Insert information into Address table
INSERT INTO ADDRESS(ADDRESSID, STATE, CITY)
VALUES(21446, 'MA', 'Boston');

INSERT INTO ADDRESS(ADDRESSID, STATE, CITY)
VALUES(30478, 'CA', 'Los Angeles');

INSERT INTO ADDRESS(ADDRESSID, STATE, CITY)
VALUES(24276, 'CA', 'San Francisco');

INSERT INTO ADDRESS(ADDRESSID, STATE, CITY)
VALUES(78134, 'TX', 'Austin');

SELECT *
FROM ADDRESS;

--Insert information into Job table
INSERT INTO JOB(JOBID, COMPANYID, ADDRESSID, JOBNAME, JOBTYPE)
VALUES(45678912, 4043, 21446, 'Data Scientist', 'F');

INSERT INTO JOB(JOBID, COMPANYID, ADDRESSID, JOBNAME, JOBTYPE)
VALUES(12390763, 4043, 30478, 'Data Analyst', 'I');

INSERT INTO JOB(JOBID, COMPANYID, ADDRESSID, JOBNAME, JOBTYPE)
VALUES(56738902, 4045, 78134, 'Market Intern', 'I');

INSERT INTO JOB(JOBID, COMPANYID, ADDRESSID, JOBNAME, JOBTYPE)
VALUES(82314675, 4046, 2647, 'System Designer', 'P');

INSERT INTO JOB(JOBID, COMPANYID, ADDRESSID, JOBNAME, JOBTYPE)
VALUES(65657813, 4044, 24276, 'Investment Consultant', 'F');

SELECT *
FROM JOB;

--Insert Application into Apply table
INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(13, 102, 4042, 23890145, 'In Progress', CAST('04-April-2020' AS DATE));

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(14, 102, 4043, 45678912, 'In Progress', CAST('22-FEB-2020' AS DATE));

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(15, 105, 4043, 45678912, 'In Progress', CAST('23-March-2020' AS DATE));

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(16, 105, 4043, 45678912, 'In Progress', CAST('26-March-2020' AS DATE));

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(17, 106, 4042, 23890145, 'In Progress', CAST('25-April-2020' AS DATE));

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(18, 101, 4046, 82314675, 'In Progress', CAST('13-November-2019' AS DATE));

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(19, 101, 4043, 12390763, 'In Progress', CAST('02-January-2020' AS DATE));

INSERT INTO APPLY(APPLYID, ACCOUNTID, COMPANYID, JOBID, STATUS, APPLYDATE)
VALUES(21,103, 4044, 65657813, 'In Progress', CAST('17-September-2019' AS DATE));

SELECT *
FROM APPLY;


--Application satus changed
UPDATE APPLY
SET STATUS = 'Interview'
WHERE APPLYID = 14;

UPDATE APPLY
SET STATUS = 'No longer consideration'
WHERE APPLYID = 14;

UPDATE APPLY
SET STATUS = 'Interview'
WHERE APPLYID = 19;

UPDATE APPLY
SET STATUS = 'Interview'
WHERE APPLYID = 13;

SELECT *
FROM STATUSCHANGE;

--Question#1. 
--This query answers this question:
--How many applications were submitted more than three months ago, but the status is still in progress? 
--We also need to view the applicants¡¯ first name and the job name.
SELECT ACCOUNT.FIRSTNAME,
       JOB.JOBNAME,
       APPLY.STATUS,
       APPLY.APPLYDATE
FROM APPLY
JOIN ACCOUNT ON ACCOUNT.ACCOUNTID = APPLY.ACCOUNTID
JOIN JOB ON JOB.JOBID = APPLY.JOBID
WHERE APPLY.APPLYID IN
        (SELECT APPLY.APPLYID
        FROM APPLY
        WHERE STATUS = 'In Progress' AND APPLYDATE < CAST('27-JAN-2020' AS DATE));

SELECT ACCOUNT.FIRSTNAME,
       JOB.JOBNAME,
       APPLY.STATUS,
       APPLY.APPLYDATE
FROM APPLY
JOIN ACCOUNT ON ACCOUNT.ACCOUNTID = APPLY.ACCOUNTID
JOIN JOB ON JOB.JOBID = APPLY.JOBID;

--Question2.
--How many applicants are there for each job?
--We also need to see the number of applicants for each job,
--the job name and the company name.
SELECT  JOB.JOBNAME, 
        COMPANY.COMPANYNAME,
        COUNT(*) AS NUM
FROM APPLY
JOIN JOB ON JOB.JOBID = APPLY.JOBID
JOIN COMPANY ON COMPANY.COMPANYID = APPLY.COMPANYID
GROUP BY JOB.JOBNAME, COMPANY.COMPANYNAME
ORDER BY NUM;

SELECT APPLY.APPLYID,
    JOB.JOBNAME,
    COMPANY.COMPANYNAME
FROM APPLY
JOIN JOB ON JOB.JOBID = APPLY.JOBID
JOIN COMPANY ON COMPANY.COMPANYID = APPLY.COMPANYID;



--Question#3.
--Which city only has one job that can be applied for? 
--We also need to see the city name and the job name.
SELECT ADDRESS.CITY,
        ADDRESS.STATE,
        JOB.JOBNAME
FROM ADDRESS
JOIN JOB ON JOB.ADDRESSID = ADDRESS.ADDRESSID
WHERE ADDRESS.ADDRESSID IN
    (SELECT ADDRESS.ADDRESSID
    FROM ADDRESS
    JOIN JOB ON JOB.ADDRESSID = ADDRESS.ADDRESSID
    GROUP BY ADDRESS.ADDRESSID
    HAVING COUNT(JOB.ADDRESSID) = 1);



SELECT ADDRESS.CITY,
       ADDRESS.STATE,
       JOB.JOBNAME
FROM ADDRESS
JOIN JOB ON JOB.ADDRESSID = ADDRESS.ADDRESSID;




